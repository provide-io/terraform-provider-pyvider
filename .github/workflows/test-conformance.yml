name: ðŸ§ª Provider Conformance Tests

on:
  workflow_dispatch:
    inputs:
      build_run_id:
        description: 'Build workflow run ID (required)'
        required: true
        type: string
  workflow_run:
    workflows: ["ðŸ—ï¸ Build Provider Binary"]
    types:
      - completed

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Check if we should run tests (skip if workflow_run failed)
  check:
    name: ðŸ” Check Build Status
    runs-on: ubuntu-24.04
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      build_run_id: ${{ steps.check.outputs.build_run_id }}

    steps:
      - name: ðŸ“‹ Determine build run ID
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            BUILD_RUN_ID="${{ github.event.workflow_run.id }}"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "build_run_id=${BUILD_RUN_ID}" >> $GITHUB_OUTPUT
            echo "âœ… Running tests with artifacts from build workflow run: ${BUILD_RUN_ID}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.build_run_id }}" ]]; then
            BUILD_RUN_ID="${{ inputs.build_run_id }}"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "build_run_id=${BUILD_RUN_ID}" >> $GITHUB_OUTPUT
            echo "âœ… Running tests with artifacts from specified build run: ${BUILD_RUN_ID}"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "âŒ ERROR: This workflow requires artifacts from the Build Provider Binary workflow"
            echo "Please run the Build Provider Binary workflow first, then either:"
            echo "  1. Let it auto-trigger this workflow, OR"
            echo "  2. Manually trigger this workflow and specify the build_run_id"
            exit 1
          fi

  conformance:
    name: ðŸ§ª Test ${{ matrix.target }}
    needs: check
    if: needs.check.outputs.should_run == 'true'
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux
            arch: amd64
            target: linux_amd64
          - os: macos-15
            platform: darwin
            arch: arm64
            target: darwin_arm64

    runs-on: ${{ matrix.os }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“– Read VERSION
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ§ª Testing version: ${VERSION}"

      - name: ðŸ“¥ Download provider artifact
        uses: actions/download-artifact@v4
        with:
          name: provider-${{ matrix.target }}
          path: provider-binary
          run-id: ${{ needs.check.outputs.build_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}

      - name: ðŸ“¦ Extract provider binary
        run: |
          cd provider-binary
          echo "ðŸ“¦ Contents of provider-binary directory:"
          ls -la
          echo ""

          echo "ðŸ“¦ Extracting provider archive..."
          unzip terraform-provider-pyvider_${{ steps.version.outputs.VERSION }}_${{ matrix.target }}.zip
          chmod +x terraform-provider-pyvider_v${{ steps.version.outputs.VERSION }}

          echo ""
          echo "âœ… Extracted provider binary:"
          ls -la terraform-provider-pyvider_v${{ steps.version.outputs.VERSION }}

      - name: ðŸ” Verify provider binary
        run: |
          PROVIDER_BINARY="provider-binary/terraform-provider-pyvider_v${{ steps.version.outputs.VERSION }}"

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ” PROVIDER BINARY VERIFICATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          echo "ðŸ“‹ Binary information:"
          ls -lah "$PROVIDER_BINARY"
          echo ""

          echo "ðŸ“‹ File type:"
          file "$PROVIDER_BINARY" || echo "file command not available"
          echo ""

          if [[ "${{ matrix.platform }}" == "linux" ]]; then
            echo "ðŸ“‹ Library dependencies (ldd):"
            ldd "$PROVIDER_BINARY" 2>&1 || echo "ldd not available or binary not dynamically linked"
          else
            echo "ðŸ“‹ Library dependencies (otool):"
            otool -L "$PROVIDER_BINARY" 2>&1 || echo "otool not available"
          fi
          echo ""

          echo "ðŸ“‹ Testing provider executable:"
          if "$PROVIDER_BINARY" --version 2>&1 | head -10; then
            echo "âœ… Provider supports --version"
          else
            echo "âš ï¸  Provider doesn't support --version, trying without arguments..."
            if timeout 5 "$PROVIDER_BINARY" 2>&1 | head -10; then
              echo "âœ… Provider is executable"
            else
              echo "âŒ Provider failed to execute"
              exit 1
            fi
          fi

          echo ""
          echo "âœ… Provider binary verification complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ðŸ”Œ Install provider to Terraform plugin directory
        run: |
          chmod +x .github/scripts/install-provider.sh
          .github/scripts/install-provider.sh \
            "${{ steps.version.outputs.VERSION }}" \
            "${{ matrix.target }}" \
            "provider-binary/terraform-provider-pyvider_v${{ steps.version.outputs.VERSION }}"

      - name: ðŸ“ Install OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.6

      - name: ðŸ Setup Python (for tofusoup)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install UV (for tofusoup)
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ðŸ² Install tofusoup
        run: |
          uv tool install tofusoup
          echo "âœ… Tofusoup installed"
          soup --version

      - name: "ðŸ”¥ Smoke Test 1: Production Mode (Minimal Config)"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”¥ SMOKE TEST 1: Production Mode (Minimal Configuration)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "This test validates that the provider loads and responds in"
          echo "production mode with a minimal Terraform configuration."
          echo ""

          mkdir -p /tmp/smoke-test-production
          cd /tmp/smoke-test-production

          cat > main.tf << 'EOF'
          terraform {
            required_providers {
              pyvider = {
                source  = "local/providers/pyvider"
                version = ">= 0.0.1"
              }
            }
          }

          provider "pyvider" {}

          output "test" {
            value = "smoke test - production mode"
          }
          EOF

          echo "ðŸ“‹ Terraform configuration:"
          cat main.tf
          echo ""

          echo "ðŸ”§ Running: tofu init"
          tofu init
          echo ""

          echo "ðŸ“Š Running: tofu plan"
          tofu plan
          echo ""

          echo "âœ… PASS: Smoke test 1 completed successfully"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: "ðŸ”¥ Smoke Test 2: Test Mode Rejection (WITHOUT PYVIDER_TESTMODE)"
        env:
          PYVIDER_PRIVATE_STATE_SHARED_SECRET: "test-secret-for-ci-only-not-production"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”¥ SMOKE TEST 2: Test Mode Rejection"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "This test validates that test-only components are correctly"
          echo "rejected when PYVIDER_TESTMODE is NOT set."
          echo ""

          cd examples/resource/private_state_verifier

          echo "ðŸ“‹ Provider configuration:"
          cat provider.tf
          echo ""

          # Ensure PYVIDER_TESTMODE is NOT set
          unset PYVIDER_TESTMODE

          echo "ðŸ”§ Running: tofu init"
          tofu init
          echo ""

          echo "ðŸ“Š Running: tofu plan (expecting rejection...)"
          set +e  # Temporarily disable exit on error
          tofu plan 2>&1 | tee /tmp/testmode-false.log
          PLAN_EXIT_CODE=${PIPESTATUS[0]}
          set -e  # Re-enable exit on error

          if [ $PLAN_EXIT_CODE -eq 0 ]; then
            # If plan succeeded, that's wrong - test-only resource should be rejected
            echo ""
            echo "âŒ FAIL: Test-only component was NOT rejected as expected"
            echo "   Expected error: 'test-only resource requires test mode'"
            cat /tmp/testmode-false.log
            exit 1
          else
            # Plan failed - check if it's the right error
            if grep -qi "test-only.*requires test mode\|test mode.*required" /tmp/testmode-false.log; then
              echo ""
              echo "âœ… PASS: Test-only component correctly rejected without test mode"
            else
              echo ""
              echo "âŒ FAIL: Plan failed but with unexpected error (exit code: $PLAN_EXIT_CODE)"
              echo "   Expected error: 'test-only resource requires test mode'"
              echo "   Actual output:"
              cat /tmp/testmode-false.log
              exit 1
            fi
          fi

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: "ðŸ”¥ Smoke Test 3: Test Mode Success (WITH PYVIDER_TESTMODE)"
        env:
          PYVIDER_TESTMODE: true
          PYVIDER_PRIVATE_STATE_SHARED_SECRET: "test-secret-for-ci-only-not-production"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”¥ SMOKE TEST 3: Test Mode Success"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "This test validates that test-only components work correctly"
          echo "when PYVIDER_TESTMODE is set."
          echo ""

          cd examples/resource/private_state_verifier

          # Clean up from previous test
          rm -rf .terraform terraform.tfstate* .terraform.lock.hcl

          # Enable test mode
          export PYVIDER_TESTMODE=true
          export PYVIDER_PRIVATE_STATE_SHARED_SECRET="${PYVIDER_PRIVATE_STATE_SHARED_SECRET}"
          echo "   PYVIDER_TESTMODE=${PYVIDER_TESTMODE}"
          echo ""

          echo "ðŸ”§ Running: tofu init"
          tofu init
          echo ""

          echo "ðŸ“Š Running: tofu plan"
          tofu plan
          echo ""

          echo "ðŸš€ Running: tofu apply -auto-approve"
          tofu apply -auto-approve
          echo ""

          echo "ðŸ“¤ Running: tofu output"
          tofu output
          echo ""

          echo "âœ… PASS: Test-only component works with test mode enabled"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ðŸ§ª Run Full Conformance Tests
        env:
          TF_LOG: DEBUG
          PYVIDER_TESTMODE: true
          PYVIDER_PRIVATE_STATE_SHARED_SECRET: "test-secret-for-ci-only-not-production"
        run: |
          # Export environment variables for all subprocesses
          export PYVIDER_TESTMODE=true
          export PYVIDER_PRIVATE_STATE_SHARED_SECRET="${PYVIDER_PRIVATE_STATE_SHARED_SECRET}"

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ§ª FULL CONFORMANCE TEST SUITE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ” Running conformance tests on all examples..."
          echo "   PYVIDER_TESTMODE=${PYVIDER_TESTMODE}"
          echo "   Platform: ${{ matrix.target }}"
          echo ""

          # Run soup stir on all examples recursively
          cd examples
          soup stir --recursive

          echo ""
          echo "âœ… All provider conformance tests passed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ðŸ“¤ Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: conformance-test-logs-${{ matrix.target }}
          path: |
            examples/**/.soup/logs/*.log
            examples/**/.soup/logs/terraform.log
            examples/**/.terraform.lock.hcl
            examples/**/terraform.tfstate*
            /tmp/smoke-test-production/.terraform/
            /tmp/smoke-test-production/terraform.tfstate*
            /tmp/smoke-test-production/.terraform.lock.hcl
            /tmp/testmode-*.log
            examples/resource/private_state_verifier/.terraform/
            examples/resource/private_state_verifier/terraform.tfstate*
            examples/resource/private_state_verifier/.terraform.lock.hcl
          retention-days: 7
          if-no-files-found: warn

  summary:
    name: ðŸ“‹ Test Summary
    needs: [check, conformance]
    if: always() && needs.check.outputs.should_run == 'true'
    runs-on: ubuntu-24.04

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          if [[ "${{ needs.conformance.result }}" == "success" ]]; then
            echo "## âœ… All Conformance Tests Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All provider conformance tests completed successfully:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Smoke Test 1: Production mode (minimal config)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Smoke Test 2: Test mode rejection (without PYVIDER_TESTMODE)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Smoke Test 3: Test mode success (with PYVIDER_TESTMODE)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Full conformance suite (all examples)" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "## âŒ Some Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the test logs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Test logs are available in the workflow artifacts." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
